# Telephone Syntax Auto-Fix Implementation

This implementation adds automatic correction of telephone number syntax to comply with RFC3966 during the minting process.

## Overview

When minting organization entities, telephone numbers are automatically transformed to the RFC3966 format, which requires:
- International format with country code
- Plus (+) prefix
- Hyphen separators

For North American phone numbers (US/Canada), the transformation adds the `+1-` prefix and formats the number as `+1-XXX-XXX-XXXX`.

## Example

**Input:** `"telephone": "250-383-8124"`  
**Output:** `"telephone": "+1-250-383-8124"`

## Files

### SPARQL Transformation
- **`app/services/sparqls/mint/transform/fix_telephone_syntax.sparql`**
  - SPARQL UPDATE query that transforms telephone numbers
  - Handles multiple input formats: dashed, dotted, parenthesized, no separators
  - Adds RDF-star annotations with provenance (prov:wasGeneratedBy)

### SHACL Validation
- **`shacl_artsdata.ttl`**
  - General SHACL shapes for validating telephone format
  - Validates RFC3966 compliance with sh:Warning severity

- **`shacl_artsdata_organization_mint.ttl`**
  - Organization-specific SHACL validation for minting
  - Ensures telephone numbers meet format requirements

### Organization Minting
- **`sparqls/mint/organization/construct_transform.sparql`**
  - SPARQL CONSTRUCT query for minting organization entities
  - Includes telephone property for auditing and transformation

### Service Layer
- **`app/services/mint_service.rb`**
  - Ruby service class that orchestrates transformations
  - `transform_graph` method applies SPARQL transformations
  - `validate_graph` method for SHACL validation
  - `mint_entities` method for type-specific minting

### Tests
- **`app/test/services/sparqls/mint/transform/test_telephone_transform.rb`**
  - Minitest test suite validating the transformation
  - Tests multiple input formats
  - Verifies SPARQL syntax and patterns

### Examples
- **`app/examples/transform_telephone_example.rb`**
  - Demonstration script showing telephone transformation
  - Usage: `bundle exec ruby app/examples/transform_telephone_example.rb`

## Supported Input Formats

The transformation handles the following North American telephone formats:

1. **Dashed:** `250-383-8124`
2. **Dotted:** `416.555.1234`
3. **No separators:** `6045551234`
4. **Parentheses:** `(514) 555-1234`
5. **Mixed:** `250 383-8124`

All are transformed to: `+1-XXX-XXX-XXXX`

## Running Tests

```bash
# Install dependencies
bundle install

# Run tests
bundle exec ruby app/test/services/sparqls/mint/transform/test_telephone_transform.rb
```

## Usage

```ruby
require_relative 'app/services/mint_service'
require 'linkeddata'

# Create a graph with telephone data
graph = RDF::Graph.new
org = RDF::URI("http://example.org/org1")
graph << [org, RDF.type, RDF::Vocab::SCHEMA.Organization]
graph << [org, RDF::Vocab::SCHEMA.telephone, "250-383-8124"]

# Transform the graph
transformed_graph = MintService.transform_graph(graph)

# Result: telephone is now "+1-250-383-8124"
```

## Provenance Annotation

Each transformed telephone number includes an RDF-star annotation indicating it was generated by the transformation script:

```turtle
<< <subject> schema:telephone "+1-250-383-8124" >> 
  prov:wasGeneratedBy <https://github.com/culturecreates/artsdata-orion/blob/main/app/services/sparqls/mint/transform/fix_telephone_syntax.sparql> .
```

## Implementation Notes

1. **Only North American numbers:** The current implementation is designed for US/Canada telephone numbers (country code +1)
2. **Non-destructive for valid numbers:** Numbers already in RFC3966 format (starting with +) are not modified
3. **Warning-level validation:** SHACL validation uses `sh:Warning` severity, not `sh:Violation`, allowing data to proceed with warnings
4. **Applied at minting:** Transformation happens automatically during the minting process for all entity types

## Dependencies

- `linkeddata` (~> 3.3) - RDF graph handling
- `sparql` (~> 3.3) - SPARQL query execution
- `nokogiri` (1.16.7) - XML/HTML parsing
- `minitest` (~> 5.0) - Testing framework
