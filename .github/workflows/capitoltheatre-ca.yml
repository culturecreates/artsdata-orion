name: Fetch capitoltheatre-ca Events

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0 1 * *' # Runs at 00:00 UTC, on day 1 of the month
      
jobs:
  artsdata-fetch-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Debug private key format with Ruby
        run: |
          ruby << 'RUBY'
          cloudflare_private_key = ENV['CLOUDFLARE_KEY']
          
          puts "=" * 50
          puts "ðŸ” CLOUDFLARE PRIVATE KEY DEBUG"
          puts "=" * 50
          
          if cloudflare_private_key.nil? || cloudflare_private_key.empty?
            puts "âŒ Key is nil or empty"
            exit 1
          end
          
          puts "âœ… cloudflare_private_key present"
          puts "Length: #{cloudflare_private_key.length}"
          puts "Lines: #{cloudflare_private_key.lines.count}"
          
          first = cloudflare_private_key.lines.first&.strip
          last = cloudflare_private_key.lines.last&.strip
          
          puts "First line: '#{first}'"
          puts "Last line: '#{last}'"
          
          puts "Contains literal \\n: #{cloudflare_private_key.include?("\\n")}"
          puts "Contains real newline: #{cloudflare_private_key.include?("\n")}"
          
          puts "\nFirst 100 chars (inspect):"
          puts cloudflare_private_key[0..100].inspect
          
          puts "\nAll lines (first 5):"
          cloudflare_private_key.lines.first(5).each_with_index do |line, i|
            puts "Line #{i}: #{line.inspect}"
          end
          
          puts "\nChecking for leading/trailing spaces:"
          cloudflare_private_key.lines.each_with_index do |line, i|
            if line != line.strip + "\n" && line != line.strip
              puts "âš ï¸  Line #{i} has extra whitespace: #{line.inspect}"
            end
          end
          
          puts "=" * 50
          RUBY
        env:
          CLOUDFLARE_KEY: ${{ secrets.CLOUDFLARE_PRIVATE_KEY }}
          
      - name: Action setup
        uses: culturecreates/artsdata-pipeline-action@v3
        with:
          mode: "fetch-push"
          artifact: "capitoltheatre-ca"
          publisher: "${{ secrets.PUBLISHER_URI_GREGORY }}"
          downloadFile: "output/capitoltheatre-events.jsonld"
          page-url: "https://capitoltheatre.ca/events/list/?tribe_paged="
          entity-identifier: "h3.tribe-events-list-event-title a"
          token: "${{ secrets.GITHUB_TOKEN }}"
          cloudflare-private-key: |
            ${{ secrets.CLOUDFLARE_PRIVATE_KEY }}
